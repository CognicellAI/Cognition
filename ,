"""Tests for observability configuration.

Tests that observability settings properly gate OTel and MLflow setup,
with graceful degradation when packages are not installed.
"""

from __future__ import annotations

from unittest.mock import MagicMock, patch

import pytest


class TestOTelConfiguration:
    """Test OpenTelemetry configuration respects settings."""

    def test_setup_tracing_skipped_when_otel_disabled(self):
        """Test that tracing setup is skipped when otel_enabled=False."""
        # Patch the logger at the module level before importing
        with patch("server.app.observability.structlog.get_logger") as mock_get_logger:
            mock_logger = MagicMock()
            mock_get_logger.return_value = mock_logger

            # Import after patching
            from server.app.observability import setup_tracing

            # Call setup with enabled=False
            setup_tracing(enabled=False)

            # Should log that tracing is disabled
            mock_logger.debug.assert_called_with(
                "OpenTelemetry tracing disabled by settings"
            )

    def test_setup_metrics_skipped_when_otel_disabled(self):
        """Test that metrics setup is skipped when otel_enabled=False."""
        # Patch the logger at the module level before importing
        with patch("server.app.observability.structlog.get_logger") as mock_get_logger:
            mock_logger = MagicMock()
            mock_get_logger.return_value = mock_logger

            # Import after patching
            from server.app.observability import setup_metrics

            # Call setup with enabled=False
            setup_metrics(enabled=False)

            # Should log that metrics are disabled
            mock_logger.debug.assert_called_with(
                "Prometheus metrics disabled by settings"
            )


class TestMLflowConfiguration:
    """Test MLflow configuration respects settings."""

    def test_setup_mlflow_skipped_when_mlflow_disabled(self):
        """Test that MLflow setup is skipped when mlflow_enabled=False."""
        # Patch the logger at the module level before importing
        with patch("server.app.mlflow_tracing.structlog.get_logger") as mock_get_logger:
            mock_logger = MagicMock()
            mock_get_logger.return_value = mock_logger

            # Import after patching
            from server.app.mlflow_tracing import setup_mlflow_tracing

            # Create mock settings with mlflow_enabled=False
            mock_settings = MagicMock()
            mock_settings.mlflow_enabled = False
            mock_settings.mlflow_tracking_uri = None
            mock_settings.mlflow_experiment_name = "test"

            # Call setup
            setup_mlflow_tracing(mock_settings)

            # Should log that MLflow is disabled
            mock_logger.debug.assert_called_with(
                "MLflow tracing disabled by settings"
            )

    def test_setup_mlflow_called_when_mlflow_enabled(self):
        """Test that MLflow setup is called when mlflow_enabled=True."""
        # Create mock MLflow module
        mock_mlflow = MagicMock()
        mock_autolog = MagicMock()

        # Patch the logger and mlflow imports
        with patch.dict(
            "sys.modules",
            {"mlflow": mock_mlflow, "mlflow.langchain": MagicMock(autolog=mock_autolog)},
        ):
            with patch("server.app.mlflow_tracing.structlog.get_logger") as mock_get_logger:
                mock_logger = MagicMock()
                mock_get_logger.return_value = mock_logger

                # Import after patching modules
                import sys

                # Remove cached module to force reimport with mocked dependencies
                if "server.app.mlflow_tracing" in sys.modules:
                    del sys.modules["server.app.mlflow_tracing"]

                from server.app.mlflow_tracing import setup_mlflow_tracing

                # Create mock settings with mlflow_enabled=True
                mock_settings = MagicMock()
                mock_settings.mlflow_enabled = True
                mock_settings.mlflow_tracking_uri = "http://localhost:5000"
                mock_settings.mlflow_experiment_name = "cognition-test"

                # Call setup
                setup_mlflow_tracing(mock_settings)

                # Should configure tracking URI
                mock_mlflow.set_tracking_uri.assert_called_with(
                    "http://localhost:5000"
                )

                # Should set experiment
                mock_mlflow.set_experiment.assert_called_with("cognition-test")

                # Should enable autologging
                mock_autolog.assert_called_once()

                # Should log success
                mock_logger.info.assert_any_call(
                    "MLflow LangChain autologging enabled"
                )

    def test_setup_mlflow_graceful_degradation_when_package_missing(self):
        """Test graceful degradation when MLflow package is not installed."""
        # Patch the logger at the module level before importing
        with patch("server.app.mlflow_tracing.structlog.get_logger") as mock_get_logger:
            mock_logger = MagicMock()
            mock_get_logger.return_value = mock_logger

            # Import after patching - module should handle missing mlflow gracefully
            from server.app.mlflow_tracing import setup_mlflow_tracing

            # Create mock settings with mlflow_enabled=True
            mock_settings = MagicMock()
            mock_settings.mlflow_enabled = True
            mock_settings.mlflow_tracking_uri = None
            mock_settings.mlflow_experiment_name = "test"

            # Call setup - should not raise exception
            setup_mlflow_tracing(mock_settings)

            # Should log warning about missing MLflow
            mock_logger.warning.assert_called_once()
            warning_msg = mock_logger.warning.call_args[0][0]
            assert "MLflow not installed" in warning_msg


class TestSettingsValidation:
    """Test observability settings validation."""

    def test_otel_enabled_defaults_to_true(self):
        """Test that otel_enabled defaults to True."""
        from server.app.settings import Settings

        # Create settings with no explicit otel_enabled
        settings = Settings()

        assert settings.otel_enabled is True

    def test_mlflow_enabled_defaults_to_false(self):
        """Test that mlflow_enabled defaults to False."""
        from server.app.settings import Settings

        # Create settings with no explicit mlflow_enabled
        settings = Settings()

        assert settings.mlflow_enabled is False

    def test_mlflow_experiment_name_defaults_to_cognition(self):
        """Test that mlflow_experiment_name defaults to 'cognition'."""
        from server.app.settings import Settings

        # Create settings with no explicit mlflow_experiment_name
        settings = Settings()

        assert settings.mlflow_experiment_name == "cognition"

    def test_otel_enabled_from_env_var(self, monkeypatch):
        """Test that otel_enabled can be set from environment variable."""
        from server.app.settings import Settings

        monkeypatch.setenv("COGNITION_OTEL_ENABLED", "false")

        settings = Settings()

        assert settings.otel_enabled is False

    def test_mlflow_enabled_from_env_var(self, monkeypatch):
        """Test that mlflow_enabled can be set from environment variable."""
        from server.app.settings import Settings

        monkeypatch.setenv("COGNITION_MLFLOW_ENABLED", "true")

        settings = Settings()

        assert settings.mlflow_enabled is True

    def test_mlflow_tracking_uri_from_env_var(self, monkeypatch):
        """Test that mlflow_tracking_uri can be set from environment variable."""
        from server.app.settings import Settings

        monkeypatch.setenv(
            "COGNITION_MLFLOW_TRACKING_URI", "http://mlflow-server:5000"
        )

        settings = Settings()

        assert settings.mlflow_tracking_uri == "http://mlflow-server:5000"

    def test_mlflow_experiment_name_from_env_var(self, monkeypatch):
        """Test that mlflow_experiment_name can be set from environment variable."""
        from server.app.settings import Settings

        monkeypatch.setenv("COGNITION_MLFLOW_EXPERIMENT_NAME", "my-experiment")

        settings = Settings()

        assert settings.mlflow_experiment_name == "my-experiment"
