# syntax=docker/dockerfile:1

# Agent Runtime Container
# This container runs the LangGraph agent with all tools

FROM python:3.11-slim-bookworm

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    ripgrep \
    patch \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
RUN groupadd -r -g 1000 agent && \
    useradd -r -u 1000 -g agent -d /home/agent -s /bin/bash agent && \
    mkdir -p /home/agent && \
    chown -R agent:agent /home/agent

# Set up workspace
RUN mkdir -p /workspace/repo && \
    chown -R agent:agent /workspace

# Install Python dependencies (as root first)
COPY agent/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# Switch to non-root user
USER agent
WORKDIR /workspace/repo

# Copy agent code
COPY --chown=agent:agent agent/ /opt/cognition/agent/
COPY --chown=agent:agent shared/ /opt/cognition/shared/

# Set Python path
ENV PYTHONPATH=/opt/cognition:$PYTHONPATH

# Expose agent WebSocket port
EXPOSE 9000

# Health check - verify WebSocket server is responding to actual WS requests
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import asyncio, websockets; asyncio.run(websockets.connect('ws://localhost:9000'))" || exit 1

# Run agent entrypoint
ENTRYPOINT ["python", "-m", "agent.entrypoint"]
